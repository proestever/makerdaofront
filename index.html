<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>MakerDAO PulseChain Dashboard</title>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600&display=swap" rel="stylesheet">
  <style>
    body {
      font-family: 'Inter', sans-serif;
      background-color: #f4f4f4;
      margin: 0;
      padding: 20px;
    }
    .container {
      max-width: 1200px;
      margin: 0 auto;
    }
    header {
      text-align: center;
      margin-bottom: 20px;
    }
    .ticker-logo {
      width: 40px;
      vertical-align: middle;
      margin: 0 10px;
    }
    h1 {
      font-size: 2.4em;
      display: inline;
      vertical-align: middle;
    }
    .card {
      background: white;
      padding: 20px;
      margin-bottom: 20px;
      border-radius: 8px;
      box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
    }
    .section-header {
      font-size: 1.5em;
      font-weight: 600;
      margin-bottom: 10px;
    }
    .status {
      font-style: italic;
      color: #666;
    }
    .error {
      color: red;
    }
    table {
      width: 100%;
      border-collapse: collapse;
      margin-top: 10px;
    }
    th, td {
      padding: 10px;
      text-align: left;
      border-bottom: 1px solid #ddd;
    }
    th {
      background-color: #f9f9f9;
    }
  </style>
</head>
<body>
  <div class="container">
    <header>
      <img src="https://tokens.app.pulsex.com/images/tokens/0x6B175474E89094C44Da98b954EedeAC495271d0F.png" alt="pDAI Logo" class="ticker-logo" />
      <h1>MakerDAO PulseChain Dashboard</h1>
      <img src="https://dd.dexscreener.com/ds-data/tokens/pulsechain/0x9f8f72aa9304c8b593d555f12ef6589cc3a579a2.png?size=xl&key=e55add" alt="pMKR Logo" class="ticker-logo" />
    </header>

    <section id="pdai-supply" class="card">
      <div class="section-header">pDAI Supply History</div>
      <div id="pdai-supply-content" class="status">⏳ Checking pDAI supply...</div>
    </section>

    <section id="pmkr-supply" class="card">
      <div class="section-header">pMKR Supply History</div>
      <div id="pmkr-supply-content" class="status">⏳ Checking pMKR supply...</div>
    </section>

    <section id="current-auctions" class="card">
      <div class="section-header">Current Auctions (All Ilks)</div>
      <div id="current-auctions-content" class="status">⏳ Loading auctions...</div>
    </section>

    <section id="flop-auctions" class="card">
      <div class="section-header">Flop Auctions (Debt Auctions)</div>
      <div id="flop-auctions-content" class="status">⏳ Loading Flop auctions...</div>
    </section>

    <section id="protocol-stats" class="card">
      <div class="section-header">Maker Protocol Stats</div>
      <div id="protocol-stats-content" class="status">⏳ Loading stats...</div>
    </section>
  </div>

  <script src="https://cdn.ethers.io/lib/ethers-6.13.5.umd.min.js"></script>
  <script>
    // Connect to PulseChain RPC
    const provider = new ethers.JsonRpcProvider('https://rpc.pulsechain.com');

    // Contract addresses (assumed same as Ethereum for PulseChain; verify if needed)
    const PDAI_ADDRESS = '0x6B175474E89094C44Da98b954EedeAC495271d0F'; // pDAI
    const PMKR_ADDRESS = '0x9f8f72aa9304c8b593d555f12ef6589cc3a579a2'; // pMKR
    const MCD_VAT_ADDRESS = '0x35d1b3f3d7966a1dfe207aa4514c12a259a0492b'; // Vat
    const MCD_FLOP_ADDRESS = '0xa41b6ef151e06da0e34b009b86e828308986736d'; // Flop
    const CLIPPER_ADDRESS = '0xc67963a226eddd77b91ad8c421630a1b0adff270'; // Example Clipper for ETH-A

    // Minimal ABIs (expand as needed)
    const ERC20_ABI = [
      {"constant":true,"inputs":[],"name":"totalSupply","outputs":[{"name":"","type":"uint256"}],"payable":false,"stateMutability":"view","type":"function"}
    ];
    const VAT_ABI = [
      {"constant":true,"inputs":[],"name":"debt","outputs":[{"name":"","type":"uint256"}],"payable":false,"stateMutability":"view","type":"function"}
    ];
    const FLOP_ABI = [
      {"constant":true,"inputs":[],"name":"kicks","outputs":[{"name":"","type":"uint256"}],"payable":false,"stateMutability":"view","type":"function"},
      {"constant":true,"inputs":[{"name":"","type":"uint256"}],"name":"bids","outputs":[{"name":"bid","type":"uint256"},{"name":"lot","type":"uint256"},{"name":"guy","type":"address"},{"name":"tic","type":"uint48"},{"name":"end","type":"uint48"}],"payable":false,"stateMutability":"view","type":"function"}
    ];
    const CLIPPER_ABI = [
      {"constant":true,"inputs":[],"name":"list","outputs":[{"name":"","type":"uint256[]"}],"payable":false,"stateMutability":"view","type":"function"},
      {"constant":true,"inputs":[{"name":"","type":"uint256"}],"name":"sales","outputs":[{"name":"pos","type":"uint256"},{"name":"tab","type":"uint256"},{"name":"lot","type":"uint256"},{"name":"usr","type":"address"},{"name":"tic","type":"uint96"},{"name":"top","type":"uint256"}],"payable":false,"stateMutability":"view","type":"function"}
    ];

    // Contract instances
    const pdaiContract = new ethers.Contract(PDAI_ADDRESS, ERC20_ABI, provider);
    const pmkrContract = new ethers.Contract(PMKR_ADDRESS, ERC20_ABI, provider);
    const vatContract = new ethers.Contract(MCD_VAT_ADDRESS, VAT_ABI, provider);
    const flopContract = new ethers.Contract(MCD_FLOP_ADDRESS, FLOP_ABI, provider);
    const clipperContract = new ethers.Contract(CLIPPER_ADDRESS, CLIPPER_ABI, provider);

    // Utility functions
    function formatWad(value) {
      return ethers.formatUnits(value, 18);
    }
    function formatNumber(num) {
      return parseFloat(num).toLocaleString('en-US', { minimumFractionDigits: 2, maximumFractionDigits: 2 });
    }

    // Fetch pDAI Supply
    async function fetchPDAISupply() {
      try {
        const supply = await pdaiContract.totalSupply();
        const formattedSupply = formatNumber(formatWad(supply));
        document.getElementById('pdai-supply-content').innerHTML = `<p>Total pDAI Supply: ${formattedSupply} pDAI</p>`;
      } catch (error) {
        document.getElementById('pdai-supply-content').innerHTML = `<p class="error">Error: ${error.message}</p>`;
      }
    }

    // Fetch pMKR Supply
    async function fetchPMKRSupply() {
      try {
        const supply = await pmkrContract.totalSupply();
        const formattedSupply = formatNumber(formatWad(supply));
        document.getElementById('pmkr-supply-content').innerHTML = `<p>Total pMKR Supply: ${formattedSupply} pMKR</p>`;
      } catch (error) {
        document.getElementById('pmkr-supply-content').innerHTML = `<p class="error">Error: ${error.message}</p>`;
      }
    }

    // Fetch Current Auctions (Liquidation Auctions via Clipper)
    async function fetchCurrentAuctions() {
      try {
        const auctionIds = await clipperContract.list();
        if (auctionIds.length === 0) {
          document.getElementById('current-auctions-content').innerHTML = '<p>No active auctions.</p>';
          return;
        }
        let table = '<table><thead><tr><th>ID</th><th>Collateral</th><th>Bid (pDAI)</th><th>Status</th></tr></thead><tbody>';
        for (const id of auctionIds) {
          const sale = await clipperContract.sales(id);
          const collateral = formatWad(sale.lot);
          const bid = formatWad(sale.tab);
          const status = sale.tic > 0 ? 'Active' : 'Ended';
          table += `<tr><td>${id}</td><td>${formatNumber(collateral)}</td><td>${formatNumber(bid)}</td><td>${status}</td></tr>`;
        }
        table += '</tbody></table>';
        document.getElementById('current-auctions-content').innerHTML = table;
      } catch (error) {
        document.getElementById('current-auctions-content').innerHTML = `<p class="error">Error: ${error.message}</p>`;
      }
    }

    // Fetch Flop Auctions (Debt Auctions)
    async function fetchFlopAuctions() {
      try {
        const kicks = await flopContract.kicks();
        if (kicks == 0) {
          document.getElementById('flop-auctions-content').innerHTML = '<p>No active Flop auctions.</p>';
          return;
        }
        let table = '<table><thead><tr><th>ID</th><th>pMKR Amount</th><th>Bid (pDAI)</th><th>Status</th></tr></thead><tbody>';
        for (let i = Math.max(0, kicks - 5); i < kicks; i++) {
          const bid = await flopContract.bids(i);
          if (bid.end > 0) {
            const mkrAmount = formatWad(bid.lot);
            const daiBid = formatWad(bid.bid);
            const status = bid.tic > 0 ? 'Active' : 'Ended';
            table += `<tr><td>${i}</td><td>${formatNumber(mkrAmount)}</td><td>${formatNumber(daiBid)}</td><td>${status}</td></tr>`;
          }
        }
        table += '</tbody></table>';
        document.getElementById('flop-auctions-content').innerHTML = table;
      } catch (error) {
        document.getElementById('flop-auctions-content').innerHTML = `<p class="error">Error: ${error.message}</p>`;
      }
    }

    // Fetch Protocol Stats (Total System Debt)
    async function fetchProtocolStats() {
      try {
        const debt = await vatContract.debt();
        const formattedDebt = formatNumber(formatWad(debt));
        document.getElementById('protocol-stats-content').innerHTML = `<p>Total System Debt: ${formattedDebt} pDAI</p>`;
      } catch (error) {
        document.getElementById('protocol-stats-content').innerHTML = `<p class="error">Error: ${error.message}</p>`;
      }
    }

    // Fetch all data
    async function fetchAllData() {
      await Promise.all([
        fetchPDAISupply(),
        fetchPMKRSupply(),
        fetchCurrentAuctions(),
        fetchFlopAuctions(),
        fetchProtocolStats()
      ]);
    }

    // Initial fetch
    fetchAllData();

    // Refresh every 5 minutes
    setInterval(fetchAllData, 300000);
  </script>
</body>
</html>
